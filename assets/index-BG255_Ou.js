(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(a){if(a.ep)return;a.ep=!0;const s=e(a);fetch(a.href,s)}})();const w=2*Math.PI,g=25.4/2,L={MAX_ITERATIONS:50,ANGLE_STEP:.01,ANGLE_TOLERANCE:1e-8,COLLISION_TOLERANCE:.001,CATENARY_POINTS:100,CATENARY_TOLERANCE:1e-7},k=class k{constructor(t,e){this.x=t,this.y=e}static getArcEnd(t,e){return new k(t*Math.cos(e),t*Math.sin(e))}dist(t){return Math.hypot(this.x-t.x,this.y-t.y)}ratio(t,e){return new k(this.x+e*(t.x-this.x),this.y+e*(t.y-this.y))}getAngle(t){const e=t.x-this.x,i=t.y-this.y;let a=0;return Math.abs(e)<1e-5?i>0?a=Math.PI/2:a=-Math.PI/2:(a=Math.atan(i/e),e<0&&(a=a+Math.PI)),a}};k.ZERO=new k(0,0);let M=k;class O{constructor(t,e,i){this.x=t,this.y=e,this.r=i}intersection(t){const e={intersectCount:0,intersectOccurs:!0,oneIsInOther:!1,areEqual:!1,p1:new M(0,0),p2:new M(0,0)},i=t.x-this.x,a=t.y-this.y,s=Math.hypot(a,i);if(s>this.r+t.r&&(e.intersectOccurs=!1),s<Math.abs(this.r-t.r)&&(e.intersectOccurs=!1,e.oneIsInOther=!0),this.x===t.x&&this.y===t.y&&this.r===t.r&&(e.areEqual=!0),e.intersectOccurs){const n=(this.r*this.r-t.r*t.r+s*s)/(2*s),r=this.x+i*n/s,o=this.y+a*n/s,c=Math.sqrt(this.r*this.r-n*n),d=-a*(c/s),l=i*(c/s);e.p1.x=r+d,e.p1.y=o+l,e.p2.x=r-d,e.p2.y=o-l,e.areEqual?e.intersectCount=null:e.p1.x===e.p2.x&&e.p1.y===e.p2.y?e.intersectCount=1:e.intersectCount=2}return e}}function x(h,t){return Math.round(h*Math.pow(10,t))/Math.pow(10,t)}function P(h){return x(180*h/Math.PI,1)}function E(h,t){let e=t;const i=h-Math.PI/2-.01;for(;e<i;)e=e+w;const a=h+Math.PI/2+.01;for(;e>a;)e=e-w;return e}function Z(h,t){const e=(a,s)=>s?e(s,a%s):a,i=e(h,t);return[h/i,t/i]}function $(h,t){const e=Z(h,t);return e[0]%2===0?[e[1],e[1]]:[e[1],e[1]*2]}class G{constructor(){this.internalf=51,this.internalr=15,this.fda=0,this.fradius=0,this.rda=0,this.rradius=0,this.cs=406,this.cl=98,this.fa=0,this.fcu=0,this.fru=0,this.fcb=0,this.frb=0,this.ra=0,this.rcu=0,this.rru=0,this.rcb=0,this.rrb=0,this.skidPatchesSingleLegged=0,this.skidPatchesAmbidextrous=0,this.modified="",this.debug=!1,this.debugCompute=!1,this.simulationSpeed=1,this.rotationSpeed=80,this.paused=!1,this.followRivet=!1,this.doDrawWheel=!0,this.halfLinkChain=g,this.fps=0,this.t=0,this.speedkmh=0,this.rpm=0,this.computeLog="",this.drawDuration=0,this.f=51,this.r=15,this.reset()}reset(){this.f=51,this.r=15,this.cs=406,this.cl=98,this.fa=0,this.fcu=0,this.fru=0,this.fcb=0,this.frb=0,this.ra=0,this.rcu=0,this.rru=0,this.rcb=0,this.rrb=0,this.modified="",this.debug=!1,this.debugCompute=!1,this.simulationSpeed=1,this.rotationSpeed=80,this.paused=!1,this.followRivet=!1,this.doDrawWheel=!0,this.halfLinkChain=g,this.fps=0,this.t=0}get f(){return this.internalf}set f(t){this.internalf=t,this.fda=2*Math.PI/this.internalf,this.fradius=g/2/Math.sin(this.fda/2),this.updateSkidPatches()}get r(){return this.internalr}set r(t){this.internalr=t,this.rda=2*Math.PI/this.internalr,this.rradius=g/2/Math.sin(this.rda/2),this.updateSkidPatches()}updateSkidPatches(){const t=$(this.f,this.r);this.skidPatchesSingleLegged=t[0],this.skidPatchesAmbidextrous=t[1]}getRivetIndex(t){for(;t<0;)t=t+this.cl;return t%this.cl}}class U{constructor(t,e){this.maxZoom=50,this.minZoom=.5,this.cameraOffset={x:172,y:358},this.cameraZoom=2,this.worldWidth=650,this.canvasBoundingClientRect=null,this.initialPinchDistance=null,this.initialPinchWorldPosition=null,this.initialPinchZoom=null,this.isDragging=!1,this.dragStart={x:0,y:0},this.canvas=t,this.main=e}initInteractive(){const t=this.canvas;window.addEventListener("resize",()=>this.onResize()),t.addEventListener("mousedown",e=>this.onPointerDown(e)),t.addEventListener("touchstart",e=>this.handleTouch(e,i=>this.onPointerDown(i))),t.addEventListener("mouseup",e=>this.onPointerUp(e)),t.addEventListener("touchend",e=>this.handleTouch(e,i=>this.onPointerUp(i))),t.addEventListener("mousemove",e=>this.onPointerMove(e)),t.addEventListener("touchmove",e=>this.handleTouch(e,i=>this.onPointerMove(i))),t.addEventListener("wheel",e=>this.adjustZoomWheel(e))}reset(){this.cameraOffset={x:172,y:358},this.cameraZoom=2,this.worldWidth=650,this.onResize()}onSidebar(t){const e=this.getWorldPosition(0,0,this.cameraOffset,this.cameraZoom);this.cameraZoom=this.cameraZoom*(this.canvas.width-t)/this.canvas.width,this.cameraOffset.x=t-e.x*this.cameraZoom}onResize(){const t=this.canvas.parentNode,e=getComputedStyle(t),i=parseInt(e.getPropertyValue("width"),10),a=parseInt(e.getPropertyValue("height"),10);this.canvas.width=i,this.canvas.height=a,this.canvasBoundingClientRect=this.canvas.getBoundingClientRect();const s=this.cameraZoom;this.cameraZoom=this.canvas.width/this.worldWidth,this.cameraOffset.x=this.cameraOffset.x*(this.cameraZoom/s),this.cameraOffset.y=this.cameraOffset.y*(this.cameraZoom/s),this.main.drawIfPaused()}getEventLocation(t){if("touches"in t&&t.touches&&t.touches.length===1)return{x:t.touches[0].clientX-(this.canvasBoundingClientRect?.left??0),y:t.touches[0].clientY-(this.canvasBoundingClientRect?.top??0)};if("clientX"in t&&t.clientX&&t.clientY)return{x:t.clientX-(this.canvasBoundingClientRect?.left??0),y:t.clientY-(this.canvasBoundingClientRect?.top??0)}}onPointerDown(t){this.isDragging=!0,this.previousCameraOffset={x:this.cameraOffset.x,y:this.cameraOffset.y};const e=this.getEventLocation(t);e&&(this.dragStart=e)}onPointerUp(t){this.isDragging=!1,this.initialPinchDistance=null,this.initialPinchWorldPosition=null,this.initialPinchZoom=null}onPointerMove(t){if(this.isDragging&&this.previousCameraOffset){const e=this.getEventLocation(t);e&&(this.cameraOffset.x=this.previousCameraOffset.x+e.x-this.dragStart.x,this.cameraOffset.y=this.previousCameraOffset.y+e.y-this.dragStart.y,this.main.drawIfPaused())}}adjustZoomWheel(t){if(!this.isDragging){const e=this.getEventLocation(t);if(!e)return;const i=this.getWorldPosition(e.x,e.y,this.cameraOffset,this.cameraZoom),a=t.deltaY/1e3;let s;t.deltaY>=0?s=1-a:s=1/(1+a),this.adjustZoom(e.x,e.y,i,this.cameraZoom*s)}}getWorldPosition(t,e,i,a){return{x:(t-i.x)/a,y:(e-i.y)/a}}adjustZoom(t,e,i,a){this.isDragging||(this.cameraZoom=a,this.cameraZoom=Math.min(this.cameraZoom,this.maxZoom),this.cameraZoom=Math.max(this.cameraZoom,this.minZoom),this.cameraOffset.x=t-i.x*this.cameraZoom,this.cameraOffset.y=e-i.y*this.cameraZoom,this.worldWidth=this.canvas.width/this.cameraZoom,this.main.drawIfPaused())}handleTouch(t,e){t.touches.length===1?e(t):t.type==="touchmove"&&t.touches.length===2&&(this.isDragging=!1,this.handlePinch(t))}handlePinch(t){t.preventDefault();const e={x:t.touches[0].clientX,y:t.touches[0].clientY},i={x:t.touches[1].clientX,y:t.touches[1].clientY},a={x:(e.x+i.x)/2-(this.canvasBoundingClientRect?.left??0),y:(e.y+i.y)/2-(this.canvasBoundingClientRect?.top??0)},s=Math.hypot(e.x-i.x,e.y-i.y);this.initialPinchDistance===null?(this.initialPinchDistance=s,this.initialPinchWorldPosition=this.getWorldPosition(a.x,a.y,this.cameraOffset,this.cameraZoom),this.initialPinchZoom=this.cameraZoom):this.initialPinchWorldPosition&&this.initialPinchZoom&&this.adjustZoom(a.x,a.y,this.initialPinchWorldPosition,this.initialPinchZoom*(s/this.initialPinchDistance))}}class H{static getCatenaryPoints(t,e,i){let a,s,n,r,o;t.x<e.x?(a=t.x,s=-t.y,n=e.x,r=-e.y,o=!1):(a=e.x,s=-e.y,n=t.x,r=-t.y,o=!0);const c=n-a,d=r-s;if(Math.sqrt(i*i)<Math.hypot(c,d)+1e-5)return[t,e];const l=(n+a)/2,u=(r+s)/2,p=Math.sqrt(i*i-d*d)/c;let f;p<3?f=Math.sqrt(6*(p-1)):f=Math.log(2*p)+Math.log(Math.log(2*p));let v=0;do f=f-(Math.sinh(f)-p*f)/(Math.cosh(f)-p),v=Math.abs(p-Math.sinh(f)/f);while(v>L.CATENARY_TOLERANCE);const C=c/(2*f),y=l-C*Math.atanh(d/i),S=u-i/(2*Math.tanh(f)),T=L.CATENARY_POINTS,m=[];for(let b=0;b<=T;b++){const I=a+b*(n-a)/T,B=-(S+C*Math.cosh((I-y)/C));m.push(new M(I,B))}return o&&m.reverse(),m}static getCatenaryIntervals(t,e,i,a){const s=H.getCatenaryPoints(t,e,i),n=[];let r=0;for(let u=0;u<s.length-1;u++){const p=s[u].dist(s[u+1]);r=r+p,n.push(p)}const o=[];let c=0,d=0;const l=r/a;for(let u=0;u<n.length;u++){const p=c+n[u];let f=!1;do if(c-.001<=d*l&&d*l<=p+.001){const v=(d*l-c)/(p-c),C=s[u].ratio(s[u+1],v);o.push(C),d++,f=!0}else f=!1;while(f);c=p}return o}}class _{constructor(t){this.state=t}getCogIndex(t,e){for(;e<0;)e=e+t;return e%t}getRivet(t,e){return t[this.state.getRivetIndex(e)]}getFrontCogPoint(t){const e=this.state.fa-t*this.state.fda;return new M(this.state.cs+this.state.fradius*Math.cos(e),this.state.fradius*Math.sin(e))}getRearCogPoint(t){const e=this.state.ra-t*this.state.rda;return new M(this.state.rradius*Math.cos(e),this.state.rradius*Math.sin(e))}getRivetsUp(t){const e=this.getFrontCogPoint(this.state.fcu),i=this.getRearCogPoint(this.state.rcu),a=this.state.getRivetIndex(this.state.rru-this.state.fru),s=H.getCatenaryIntervals(e,i,a*g,a);for(let n=0;n<s.length;n++)t.push(s[n])}getRivetsRear(t){const e=this.state.getRivetIndex(this.state.rrb-this.state.rru);for(let i=1;i<e;i++){const a=this.state.rcu+i,s=this.getRearCogPoint(a);t.push(s)}}getRivetsDown(t){const e=this.getRearCogPoint(this.state.rcb),i=this.getFrontCogPoint(this.state.fcb),a=this.state.getRivetIndex(this.state.frb-this.state.rrb),s=H.getCatenaryIntervals(e,i,a*g,a);for(let n=0;n<s.length;n++)t.push(s[n])}getRivetsFront(t){const e=this.state.getRivetIndex(this.state.fru-this.state.frb);for(let i=1;i<e;i++){const a=this.state.fcb+i,s=this.getFrontCogPoint(a);t.push(s)}}getRivets(){const t=[];this.getRivetsUp(t),this.getRivetsRear(t),this.getRivetsDown(t),this.getRivetsFront(t);const e=[];for(let i=0;i<this.state.cl;i++)e.push(t[this.state.getRivetIndex(i-this.state.fru)]);return e}}class q{constructor(t,e){this.rivets=[],this.onceModified=!1,this.modified=!1,this.broken=!1,this.iterations=0,this.state=t,this.rivetsCalculator=e}reset(){const t=this.state,e=Math.asin((t.f-t.r)/t.cs);t.fa=-Math.PI/2,t.fcu=0,t.fru=0;const i=Math.round(t.f/2);t.fcb=t.fcu-i,t.frb=t.fru-i,t.ra=-Math.PI/2;const a=Math.round(t.r/2);t.rcu=0,t.rcb=t.rcu+a;const s=Math.round(t.cs*Math.cos(e)/g)+2;t.rotationSpeed>0?(t.rru=s,t.rrb=t.rru+a):(t.rrb=t.frb-s,t.rru=t.rrb-a),this.moduloState()}debugAngles(t,e,i,a){this.state.debugCompute&&console.log("fixed :"+t+" -  mina: "+P(e)+" ra: "+P(i)+" maxa: "+P(a))}moduloState(){const t=this.state;t.fa=E(0,t.fa),t.fcu=(t.fcu+t.f)%t.f,t.fru=(t.fru+t.cl)%t.cl,t.fcb=(t.fcb+t.f)%t.f,t.frb=(t.frb+t.cl)%t.cl,t.ra=E(0,t.ra),t.rcu=(t.rcu+t.r)%t.r,t.rru=(t.rru+t.cl)%t.cl,t.rcb=(t.rcb+t.r)%t.r,t.rrb=(t.rrb+t.cl)%t.cl}setBroken(){this.broken=!0,this.reset(),this.setModified()}setModified(){this.rivets=this.rivetsCalculator.getRivets(),this.modified=!0,this.onceModified=!0}checkState(){const t=this.state,e=this.state.getRivetIndex(t.fru-t.frb),i=this.rivetsCalculator.getCogIndex(t.f,t.fcu-t.fcb),a=this.state.getRivetIndex(t.rrb-t.rru),s=this.rivetsCalculator.getCogIndex(t.r,t.rcb-t.rcu);(e!==i||a!==s)&&(console.error(["invalid state",t]),this.setBroken())}chainTensionUp(){const t=this.state,e=this.rivets,i=this.rivetsCalculator.getRivet(e,t.fru),a=this.rivetsCalculator.getRivet(e,t.rru),s=i.dist(a),n=t.halfLinkChain*this.state.getRivetIndex(t.rru-t.fru);if(s>=n){const r=new O(i.x,i.y,n).intersection(new O(0,0,t.rradius));if(r.intersectOccurs){let o;r.p1.y<0?o=r.p1:o=r.p2;const c=t.ra-t.rcu*t.rda,d=E(c,M.ZERO.getAngle(o));Math.abs(d-c)>L.COLLISION_TOLERANCE&&(this.logCompute(["fixed chain tension, da : ",d-c]),t.ra=t.ra+(d-c),this.setModified())}else this.logCompute(["impossible to make chain tension",t]),this.setBroken()}}chainTensionDown(){const t=this.state,e=this.rivets,i=this.rivetsCalculator.getRivet(e,t.frb),a=this.rivetsCalculator.getRivet(e,t.rrb),s=i.dist(a),n=t.halfLinkChain*this.state.getRivetIndex(t.frb-t.rrb);if(s>=n){const r=new O(i.x,i.y,n).intersection(new O(0,0,t.rradius));if(r.intersectOccurs){let o;r.p1.y>0?o=r.p1:o=r.p2;const c=t.ra-t.rcb*t.rda,d=E(c,M.ZERO.getAngle(o));Math.abs(d-c)>L.COLLISION_TOLERANCE&&(this.logCompute(["fixed chain tension, da : ",d-c]),t.ra=t.ra+(d-c),this.setModified())}else this.logCompute(["impossible to make chain tension",t]),this.setBroken()}}fixRivet(t,e,i,a,s,n,r){const o=this.rivets,c=this.rivetsCalculator.getRivet(o,e),d=this.rivetsCalculator.getRivet(o,i);let l,u,p;a?(l=this.rivetsCalculator.getFrontCogPoint(s-1),u=this.rivetsCalculator.getFrontCogPoint(s),p=this.rivetsCalculator.getFrontCogPoint(s+1)):(l=this.rivetsCalculator.getRearCogPoint(s-1),u=this.rivetsCalculator.getRearCogPoint(s),p=this.rivetsCalculator.getRearCogPoint(s+1));const f=c.getAngle(d),v=E(f,l.getAngle(u)),C=E(f,u.getAngle(p)),y=Math.min(C,v),S=Math.max(C,v);f<y-L.COLLISION_TOLERANCE?(this.debugAngles(t+" ra < mina",y,f,S),n(),this.setModified()):f>S+L.COLLISION_TOLERANCE&&(this.debugAngles(t+" ra > maxa",y,f,S),r(),this.setModified())}logCompute(t){this.state.debugCompute&&console.log(t)}computeLoop(){const t=this.state;let e=0,i=!1;this.rivets=this.rivetsCalculator.getRivets();do this.iterations++,e++,this.modified=!1,e>=L.MAX_ITERATIONS&&(console.warn(`Physics computation overflow after ${L.MAX_ITERATIONS} iterations`),i=!0),this.checkState(),t.rotationSpeed>0?this.chainTensionUp():this.chainTensionDown(),this.fixRivet("front up",t.fru,t.fru+1,!0,t.fcu,()=>{t.fcu+=1,t.fru+=1},()=>{t.fcu-=1,t.fru-=1}),this.fixRivet("front bottom",t.frb-1,t.frb,!0,t.fcb,()=>{t.fcb+=1,t.frb+=1},()=>{t.fcb-=1,t.frb-=1}),this.fixRivet("rear bottom",t.rrb,t.rrb+1,!1,t.rcb,()=>{t.rcb+=1,t.rrb+=1},()=>{t.rcb-=1,t.rrb-=1}),this.fixRivet("rear up",t.rru-1,t.rru,!1,t.rcu,()=>{t.rcu+=1,t.rru+=1},()=>{t.rcu-=1,t.rru-=1});while(this.modified&&!i)}compute(t){const e=this.state,i=performance.now();this.logCompute(["start compute"]);const a=e.simulationSpeed*(t/1e3);e.t+=a;const s=e.ra,n=a*(e.rotationSpeed*w/60),r=e.fa+n;this.onceModified=!1,this.modified=!1,this.broken=!1,this.iterations=0;let o=!1;for(t===0&&(o=!0);!this.broken&&(Math.abs(e.fa-r)>L.ANGLE_TOLERANCE||o);)n>0?(e.fa=e.fa+L.ANGLE_STEP,e.fa>r&&(e.fa=r)):(e.fa=e.fa-L.ANGLE_STEP,e.fa<r&&(e.fa=r)),this.computeLoop(),o=!1;this.moduloState();const c=E(0,e.ra-s),d=2100/(1e3*1e3)*(c/w),l=t/(1e3*3600),u=d/l;e.speedkmh=u;const p=n/w,f=t/(1e3*60),v=p/f;e.rpm=v;const C=performance.now()-i;e.computeLog=this.onceModified+" "+this.iterations+" "+x(C,1)+"ms",this.logCompute(["end compute"])}}const W=70*Math.PI/180,D=Math.PI-60*Math.PI/180;class F{constructor(t,e,i,a){this.n=t,this.r=e,this.a=i,this.da=a}}class X{constructor(t,e){this.ctx=t,this.state=e}drawCog(t,e){const i=this.ctx;i.save(),i.rotate(t.a-e*t.da);const a=M.getArcEnd(t.r+2,t.da/2),s=M.getArcEnd(t.r+2,-t.da/2),n=t.da/2;i.arc(a.x,a.y,1.6,n,n-W,!0),i.arc(t.r,0,3.7,D,-D),i.arc(s.x,s.y,1.6,W-n,-n,!0),i.restore()}drawCogDebug(t,e){const i=this.ctx;i.save(),i.rotate(t.a-e*t.da),i.fillText(""+e,t.r+10,0),i.beginPath(),i.lineTo(t.r,0);const a=M.getArcEnd(t.r,t.da);i.lineTo(a.x,a.y),i.stroke(),i.closePath(),i.restore()}drawCogsLabel(t){const e=this.ctx;e.save(),e.rotate(t.a),e.translate(t.r-10,0),e.rotate(Math.PI/2),e.font="10px serif",e.lineWidth=.5,e.strokeStyle="#000",e.strokeText(String(t.n),0,0),e.restore()}drawCogsInternal(t){const e=this.ctx,i=this.state.debug;e.fillStyle="#ddd",e.strokeStyle="#000",e.beginPath();for(let a=0;a<t.n;a++)this.drawCog(t,a);if(e.stroke(),i||e.fill(),e.closePath(),i){e.save(),e.fillStyle="#055",e.strokeStyle="#055",e.lineWidth=.1;for(let a=0;a<t.n;a++)this.drawCogDebug(t,a);e.restore()}this.drawCogsLabel(t)}drawFrontCogs(){const t=this.state,e=this.ctx;e.save(),e.translate(t.cs,0),this.drawCogsInternal(new F(t.f,t.fradius,t.fa,t.fda)),e.restore()}drawRearCogs(){const t=this.state;this.drawCogsInternal(new F(t.r,t.rradius,t.ra,t.rda))}drawCogs(){this.drawFrontCogs(),this.drawRearCogs()}}class Y{constructor(t,e,i){this.ctx=t,this.state=e,this.drawer=i}drawRawRivet(){const t=this.ctx,e=5,i=g/8,a=g/4,s=1;t.arc(0,0,e,Math.PI/2,3*Math.PI/2),t.bezierCurveTo(i,-e,g/2-a,-e+s,g/2,-e+s),t.bezierCurveTo(g/2+a,-e+s,g-i,-e,g,-e),t.arc(g,0,e,-Math.PI/2,Math.PI/2),t.bezierCurveTo(g-i,e,g/2+a,e-s,g/2,e-s),t.bezierCurveTo(g/2-a,e-s,i,e,0,e)}drawLink(t,e,i){const a=this.state.debug,s=this.ctx,n=t.dist(e);s.save(),s.translate(t.x,t.y);const r=t.getAngle(e);s.rotate(r);let o=0;if(n<g?o=(n-g)/n:n>this.state.halfLinkChain&&(o=(n-this.state.halfLinkChain)/n),a){s.lineWidth=.1,s.fillStyle="#000";const d=Math.round(o*1e3);s.fillText(i+" "+d,0,5),this.drawer.drawCircle(0,0,3.7),s.save(),o>1e-4&&(o=Math.max(.025,o)),o<-1e-4&&(o=Math.min(-.025,o));const l=120-Math.max(-120,Math.min(120,Math.round(120*o/.05)));s.strokeStyle="hsla("+l+", 100%, 50%, 1)",s.beginPath();let u=0;i%2===1?u=1:u=-1,s.moveTo((n-g)/2,u),s.lineTo((n-g)/2,0),s.lineTo(n-(n-g)/2,0),s.lineTo(n-(n-g)/2,u),s.stroke(),s.closePath(),s.restore()}if(s.translate((n-g)/2,0),Math.abs(o)>1e-4){const d=Math.max(50,Math.min(100,Math.round(100*o/.05)));s.fillStyle="hsla(0, "+d+"%, 87%, 1)"}else s.fillStyle="hsla(0, 0%, 87%, 1)";s.beginPath(),this.drawRawRivet(),a||s.fill(),s.stroke(),s.closePath(),!a&&i%2===1&&(s.fillStyle="#ccc",this.drawer.drawCircle(0,0,2,!0),this.drawer.drawCircle(n,0,2,!0)),i%10===1&&(s.save(),s.font="3.5px serif",s.lineWidth=.1,s.strokeStyle="#000",s.strokeText("GLA",n/2,.4),s.restore()),s.restore()}drawLinks(t){for(let e=0;e<t.length-1;e=e+2)this.drawLink(t[e],t[e+1],e);this.drawLink(t[t.length-1],t[0],t.length-1);for(let e=1;e<t.length-1;e=e+2)this.drawLink(t[e],t[e+1],e)}}class z{constructor(t,e,i){this.ctx=t,this.state=e,this.drawer=i,this.wheel={total:668/2,rim:622/2,brakeHeight:11,rimHeight:32,hub:90/2,hubSpoke:84/2}}drawWheelCircle(t,e){const i=this.ctx;i.save(),i.fillStyle=e,i.strokeStyle="#000",this.drawer.drawCircle(0,0,t,!0),i.restore()}drawValveRect(t,e,i){const a=this.state.debug,s=this.ctx;s.beginPath(),s.moveTo(i,e/2),s.lineTo(i+t,e/2),s.lineTo(i+t,-e/2),s.lineTo(i,-e/2),s.lineTo(i,e/2),a||s.fill(),s.stroke(),s.closePath()}drawValve(){const t=this.ctx,e=this.wheel;t.save(),t.translate(e.rim-e.rimHeight,0),t.rotate(Math.PI),t.lineWidth=.1,t.strokeStyle="#000",t.fillStyle="#ad8052",this.drawValveRect(22,6,0),this.drawValveRect(5,5,22),t.fillStyle="#aaa",this.drawValveRect(5,4,27),t.fillStyle="#ad8052",this.drawValveRect(3,2,32),t.restore()}drawLogo(t,e,i,a){const s=this.ctx;s.save(),s.textBaseline="bottom",s.textAlign="left",s.rotate(a),s.fillStyle=e,s.font="bold 12px serif";let n="";const o=-s.measureText(i).width/2/t;for(let c=0;c<i.length;c++){const d=i.charAt(c);s.save();const l=s.measureText(n).width;s.rotate(o+l/t),s.translate(t,0),s.rotate(Math.PI/2),s.lineWidth=.5,s.fillText(d,0,0),s.restore(),n=n+d}s.restore()}drawNipples(){const t=this.ctx,e=this.wheel;t.save(),t.rotate(w/48),t.strokeStyle="#000",t.fillStyle="#999";for(let i=0;i<24;i++)t.save(),t.rotate(i*w/24),t.translate(e.rim-e.rimHeight,0),t.rotate(Math.PI),this.drawValveRect(9,3,0),t.restore();t.restore()}drawSpokes(t){const e=this.ctx,i=this.wheel;for(let a=0;a<24;a++)if(!t&&a%4===2&&(e.save(),e.lineWidth=.1,e.strokeStyle="#000",e.fillStyle="#444",e.rotate(a*w/24),this.drawer.drawCircle(i.hubSpoke,0,2,!0),e.restore()),!t&&a%4===0&&(e.save(),e.lineWidth=.1,e.strokeStyle="#000",e.fillStyle="#ddd",e.rotate(a*w/24),this.drawer.drawCircle(i.hubSpoke,0,1.5,!0),e.restore()),t&&a%4!==0||!t&&a%4===0){e.save(),e.lineCap="round",e.strokeStyle="#000",e.lineWidth=2,e.rotate(a*w/24);let s;a%2===0?s=3.5*w/24:s=-2.5*w/24,e.beginPath(),e.moveTo(i.hubSpoke,0);const n=M.getArcEnd(i.rim-i.rimHeight-9,s);e.lineTo(n.x,n.y),e.stroke(),e.closePath(),e.restore()}}drawWheel(){const t=this.ctx,e=this.wheel;t.save(),t.rotate(this.state.ra),this.drawWheelCircle(e.total,"#555"),this.drawWheelCircle(e.rim,"#eee"),this.drawWheelCircle(e.rim-e.brakeHeight,"#ddd"),this.drawWheelCircle(e.rim-e.rimHeight,"#fff"),this.drawSpokes(!0),this.drawWheelCircle(e.hub,"#eee"),this.drawSpokes(!1),this.drawNipples(),this.drawValve(),this.drawLogo(e.rim+4,"#fff","N-Peloton",0),this.drawLogo(e.rim+4,"#fff","My drinking team has a cycling problem",Math.PI),this.drawLogo(e.rim-e.rimHeight+2,"#000","Fonderies",Math.PI/2),this.drawLogo(e.rim-e.rimHeight+2,"#000","Mercredi 20h30",-Math.PI/2),t.restore()}}class j{constructor(t,e,i,a,s){this.canvas=t,this.ctx=e,this.state=i,this.rivetsCalculator=a,this.interactive=s,this.cogsDrawer=new X(e,i),this.rivetsDrawer=new Y(e,i,this),this.wheelDrawer=new z(e,i,this)}drawCircle(t,e,i,a=!1){const s=this.ctx,n=this.state.debug;s.beginPath(),s.arc(t,e,i,0,w),a&&!n&&s.fill(),s.stroke(),s.closePath()}printStateValues(t){const e=this.ctx;e.save(),e.font="16px serif",e.fillStyle="rgba(255,255,255,0.7)";let i=0;for(let s=0;s<t.length;s++)i=Math.max(i,e.measureText(t[s]).width);const a=this.canvas.width-i-10;e.fillRect(a,4,i,17*t.length),e.fillStyle="#000";for(let s=0;s<t.length;s++)e.fillText(t[s],a,20+17*s);e.restore()}getCommonValues(){const t=this.state;return["Single-legged skid patches: "+t.skidPatchesSingleLegged,"Ambidextrous skid patches: "+t.skidPatchesAmbidextrous,"Speed (km/h): "+x(t.speedkmh,1),"RPM: "+x(t.rpm,1)+"rpm","","FPS: "+x(t.fps,0)]}getDebugValues(){const t=this.getCommonValues(),e=this.state,i=["","t: "+x(e.t,5),"fa: "+P(e.fa)+"°","fcu: "+e.fcu,"fru: "+e.fru,"fcb: "+e.fcb,"frb: "+e.frb,"ra: "+P(e.ra)+"°","rcu: "+e.rcu,"rru: "+e.rru,"rcb: "+e.rcb,"rrb: "+e.rrb,"computeLog: "+e.computeLog,"Last draw: "+x(e.drawDuration,2)+"ms","cameraOffset.x: "+x(this.interactive.cameraOffset.x,2),"cameraOffset.y: "+x(this.interactive.cameraOffset.y,2),"cameraZoom: "+x(this.interactive.cameraZoom,2),"worldWidth: "+x(this.interactive.worldWidth,2)];return t.push(...i),t}draw(){const t=this.ctx,e=this.state,i=e.debug,a=e.paused,s=performance.now();t.save(),t.setTransform(1,0,0,1,0,0),i||a?t.fillStyle="rgba(255,255,255,1.0)":t.fillStyle="rgba(255,255,255,0.7)",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.restore(),t.save(),t.font="5px serif",t.textBaseline="middle",t.textAlign="center",t.lineWidth=.3,t.translate(this.interactive.cameraOffset.x,this.interactive.cameraOffset.y),t.scale(this.interactive.cameraZoom,this.interactive.cameraZoom);const n=this.rivetsCalculator.getRivets();let r,o;if(e.followRivet&&(r=this.rivetsCalculator.getRivet(n,0),o=this.rivetsCalculator.getRivet(n,1),r&&o)){const c=r.getAngle(o);t.rotate(Math.PI-c),t.translate(-r.x,-r.y)}e.doDrawWheel&&this.wheelDrawer.drawWheel(),this.cogsDrawer.drawCogs(),this.rivetsDrawer.drawLinks(n),e.followRivet&&r&&(t.beginPath(),t.lineTo(r.x-5,r.y),t.lineTo(r.x+5,r.y),t.stroke(),t.closePath(),t.beginPath(),t.lineTo(r.x,r.y+5),t.lineTo(r.x,r.y-5),t.stroke(),t.closePath()),t.restore(),i?this.printStateValues(this.getDebugValues()):this.printStateValues(this.getCommonValues()),e.drawDuration=performance.now()-s}}class K{constructor(t,e,i){this.previousChrono=0;const a=document.getElementById(e);if(!a||!(a instanceof HTMLCanvasElement))throw new Error(`Canvas element with id '${e}' not found`);this.canvas=a;const s=this.canvas.getContext("2d");if(!s)throw new Error("Failed to get 2D rendering context");this.interactive=new U(this.canvas,this),this.interactive.initInteractive(),this.state=t;const n=new _(this.state);this.computer=new q(this.state,n),this.drawer=new j(this.canvas,s,this.state,n,this.interactive),this.onReset=i}start(){this.previousChrono=0,this.resetState(),requestAnimationFrame(t=>this.frame(t))}frame(t){if(this.previousChrono===void 0&&(this.previousChrono=t),this.state.paused)this.state.fps=0;else{let e=Math.max(1,t-this.previousChrono);this.state.fps=1e3/e,e>100&&(e=16);try{this.computer.compute(e)}catch(i){console.error("Physics computation error:",i),this.computer.reset(),this.state.paused=!0}this.drawer.draw()}this.previousChrono=t,requestAnimationFrame(e=>this.frame(e))}resetState(){this.state.reset(),this.reset()}resetComputer(){this.computer.reset(),this.computer.compute(0)}reset(){this.resetComputer(),this.onReset(),this.interactive.reset()}drawIfPaused(){this.state.paused&&this.drawer.draw()}compute0(){this.computer.moduloState(),this.computer.compute(0),this.drawer.draw()}}class R{constructor(t,e,i,a,s=r=>r,n=r=>r){const r=document.getElementById(t);if(!r||!(r instanceof HTMLInputElement))throw new Error(`Input element with id '${t}' not found`);this.inputElement=r,this.spanElement=document.getElementById(t+"Value"),this.toHuman=e,this.valueSetter=a,this.valueGetter=i,this.valueFromInput=s,this.valueToInput=n,this.inputElement.addEventListener("input",o=>this.onInput(o))}onInput(t){try{const e=t.target,i=parseFloat(e.value);isNaN(i)||(this.valueSetter(this.valueFromInput(i)),this.setTextValue())}catch(e){console.error("Input validation error:",e)}}setInputValue(){this.inputElement.value=String(this.valueToInput(this.valueGetter()))}setTextValue(){if(this.spanElement)try{this.spanElement.innerText=this.toHuman(this.inputElement.value)}catch(t){console.error("Text display error:",t),this.spanElement.innerText="Error"}}reset(){this.setInputValue(),this.setTextValue()}}class A{constructor(t,e,i){const a=document.getElementById(t);if(!a||!(a instanceof HTMLInputElement))throw new Error(`Checkbox element with id '${t}' not found`);this.inputElement=a,this.valueSetter=i,this.valueGetter=e,this.inputElement.addEventListener("change",s=>{const n=s.target;this.valueSetter(n.checked)})}reset(){this.inputElement.checked=this.valueGetter()}}function N(h,t,e,i){const a=g*(1+i),s=e*a,n=h*a/(2*Math.PI),r=t*a/(2*Math.PI),o=2,c=Math.PI*(n+r)-s,d=Math.pow(n-r,2),l=c*c-4*o*d;return l<0?null:(-c+Math.sqrt(l))/(2*o)-.2}function J(h,t,e){const i=[];for(let a=e.cogMin;a<=e.cogMax;a++){const s=h/a,n=s>=e.ratioMin&&s<=e.ratioMax,r=N(h,a,t,0);if(r===null||r<e.csMin||r>e.csMax)continue;const o=N(h,a,t,e.maxChainWear);if(o===null||o<e.csMin||o>e.csMax)continue;const c=$(h,a);i.push({chainring:h,cog:a,ratio:s,ratioValid:n,chainstay:r,chainstayWeared:o,skidPatchesSingleLegged:c[0],skidPatchesAmbidextrous:c[1]})}return i.sort((a,s)=>s.ratio-a.ratio),i}const Q=.35,tt=.3,et=.2,it=.15,st=15;function at(h,t,e){const i=t.flatMap(m=>m.allCogs);i.sort((m,b)=>m.ratio-b.ratio);const a=i.filter(m=>m.ratioValid),s=a.length,n=t.length,r=t.map(m=>m.chainring);if(s===0)return{chainLinks:h,chainrings:r,score:0,maxGap:0,ratioCount:0,ratioCoverage:0,allCogs:i,coverageScore:0,countScore:0,evennessScore:0,reusabilityScore:0};a.sort((m,b)=>m.ratio-b.ratio);const o=a.map(m=>m.ratio),c=o[0],l=o[s-1]-c,u=e.ratioMax-e.ratioMin,p=[];let f=0;for(let m=1;m<s;m++){const b=o[m]-o[m-1];p.push(b),b>f&&(f=b)}let v;s===1?v=0:u<=0?v=1:v=Math.min(l/u,1);const C=Math.min(Math.log(s+1)/Math.log(st+1),1);let y;if(s<=2)y=1;else{const m=l/(s-1);if(m<=0)y=1;else{let b=0;for(const V of p)b+=Math.pow(V-m,2);y=1/(1+Math.sqrt(b/p.length)/m)}}let S;if(n<=1)S=0;else{const m=new Set(a.map(B=>B.cog)).size,b=s,I=m*(n-1);I<=0?S=0:S=Math.min((b-m)/I,1)}const T=v*(Q+tt*C+et*y+it*S);return{chainLinks:h,chainrings:r,score:T,ratioCount:s,ratioCoverage:v,maxGap:f,allCogs:i,coverageScore:v,countScore:C,evennessScore:y,reusabilityScore:S}}function nt(h,t){let e=[];for(let i=1;i<=t;i++)e=e.concat(rt(h,i));return e}function rt(h,t){if(t===0)return[[]];if(t>h.length)return[];const e=[];function i(a,s){if(s.length===t){e.push([...s]);return}for(let n=a;n<h.length;n++)s.push(h[n]),i(n+1,s),s.pop()}return i(0,[]),e}function ot(h){const t=[],e=h.allowHalfLink||h.chainLinksMin%2===0?h.chainLinksMin:h.chainLinksMin+1,i=h.allowHalfLink?1:2;for(let a=e;a<=h.chainLinksMax;a+=i){const s=[];for(let n=h.chainringMin;n<=h.chainringMax;n++){const r=J(n,a,h);r.filter(o=>o.ratioValid).length!==0&&s.push({chainring:n,allCogs:r})}if(s.length>0){const n=nt(s,h.chainringCount);for(const r of n)r.sort((o,c)=>o.chainring-c.chainring),t.push(at(a,r,h))}}return t.sort((a,s)=>s.score-a.score),t}class ht{constructor(t,e,i){this.modal=null,this.overlay=null,this.resultsContainer=null,this.inputs={},this.lastInputs=null,this.expandedRows=new Set,this.dragStart=null,this.modalMinLeft=0,this.modalMaxLeft=0,this.modalMinTop=0,this.modalMaxTop=0,this.boundMouseMove=null,this.boundMouseUp=null,this.state=t,this.main=e,this.onUiUpdate=i,this.inputConfigs=this.getInputConfigs()}getInputConfigs(){return[{id:"csRange",label:"Chainstay (mm)",min:350,max:450,step:1,defaultMin:381,defaultMax:396},{id:"ratioRange",label:"Target Ratio",min:1.5,max:5,step:.1,defaultMin:2.6,defaultMax:3.4},{id:"cogRange",label:"Cog Teeth",min:11,max:25,step:1,defaultMin:13,defaultMax:21},{id:"chainringRange",label:"Chainring Teeth",min:28,max:70,step:1,defaultMin:46,defaultMax:55},{id:"chainLinksRange",label:"Chain Links",min:80,max:130,step:1,defaultMin:80,defaultMax:130}]}init(){this.createModal(),this.createOpenButton(),this.bindEvents()}createModal(){this.overlay=document.createElement("div"),this.overlay.id="ratio-finder-overlay",this.overlay.className="ratio-finder-overlay",this.modal=document.createElement("div"),this.modal.id="ratio-finder-modal",this.modal.className="ratio-finder-modal";const t=document.createElement("div");t.className="ratio-finder-header",t.innerHTML=`
      <h2>Chainring Finder</h2>
      <button class="ratio-finder-close">&times;</button>
    `;const e=document.createElement("div");e.className="ratio-finder-inputs";const i=document.createElement("div");i.className="ratio-finder-inputs-header",i.innerHTML=`
      <span class="collapse-icon">▼</span>
      <span>Search Parameters</span>
    `;const a=document.createElement("div");a.className="ratio-finder-inputs-content",a.innerHTML=this.createInputsHtml(),e.appendChild(i),e.appendChild(a),this.resultsContainer=document.createElement("div"),this.resultsContainer.className="ratio-finder-results",this.resultsContainer.innerHTML='<p class="placeholder">Configure inputs and click "Find Combinations"</p>';const s=document.createElement("div");s.className="ratio-finder-footer",s.innerHTML=`
      <button id="ratio-finder-search" class="ratio-finder-btn primary">Find Combinations</button>
      <button id="ratio-finder-cancel" class="ratio-finder-btn">Close</button>
    `,this.modal.appendChild(t),this.modal.appendChild(e),this.modal.appendChild(this.resultsContainer),this.modal.appendChild(s),document.body.appendChild(this.overlay),document.body.appendChild(this.modal),this.storeInputReferences()}createInputsHtml(){let t='<div class="ratio-finder-input-grid">';for(const e of this.inputConfigs)t+=`
        <div class="ratio-finder-input-row">
          <label>${e.label}:</label>
          <div class="range-inputs">
            <input type="number" id="${e.id}Min"
                   min="${e.min}" max="${e.max}" step="${e.step}"
                   value="${e.defaultMin}">
            <span>to</span>
            <input type="number" id="${e.id}Max"
                   min="${e.min}" max="${e.max}" step="${e.step}"
                   value="${e.defaultMax}">
          </div>
        </div>
      `;return t+=`
      <div class="ratio-finder-input-row">
        <label>Half-link Chain:</label>
        <input type="checkbox" id="allowHalfLink">
        <span class="hint">(allows odd link counts)</span>
      </div>
    `,t+=`
      <div class="ratio-finder-input-row">
        <label>Max Chain Wear (%):</label>
        <div class="range-inputs">
          <input type="number" id="maxChainWearInput" min="0" max="1" step="0.1" value="0.75">
        </div>
      </div>
    `,t+=`
      <div class="ratio-finder-input-row">
        <label>Chainring Count:</label>
        <div class="range-inputs">
          <select id="chainringCountInput">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
          </select>
        </div>
      </div>
    `,t+="</div>",t}storeInputReferences(){for(const t of this.inputConfigs)this.inputs[t.id+"Min"]=document.getElementById(t.id+"Min"),this.inputs[t.id+"Max"]=document.getElementById(t.id+"Max");this.inputs.allowHalfLink=document.getElementById("allowHalfLink"),this.inputs.maxChainWearInput=document.getElementById("maxChainWearInput"),this.inputs.chainringCountInput=document.getElementById("chainringCountInput")}createOpenButton(){const t=document.getElementById("sidebar-content");if(!t)return;const e=document.createElement("div");e.style.padding="5px";const i=document.createElement("button");i.id="openRatioFinder",i.textContent="Chainring Finder",i.className="ratio-finder-open-btn",e.appendChild(i),t.appendChild(e)}bindEvents(){const t=document.getElementById("openRatioFinder");if(t&&t.addEventListener("click",()=>this.open()),!this.modal||!this.overlay)return;const e=this.modal.querySelector(".ratio-finder-close");e&&e.addEventListener("click",()=>this.close());const i=this.modal.querySelector(".ratio-finder-header");i&&(i.addEventListener("mousedown",r=>this.onHeaderDown(r)),i.addEventListener("touchstart",r=>this.onHeaderDown(r)));const a=document.getElementById("ratio-finder-cancel");a&&a.addEventListener("click",()=>this.close()),this.overlay.addEventListener("click",()=>this.close());const s=this.modal.querySelector(".ratio-finder-inputs-header");s&&s.addEventListener("click",()=>this.toggleInputs());const n=document.getElementById("ratio-finder-search");n&&n.addEventListener("click",()=>this.search()),document.addEventListener("keydown",r=>{r.key==="Escape"&&this.isOpen()&&this.close()}),this.modal.addEventListener("keydown",r=>{r.key==="Enter"&&r.target.tagName==="INPUT"&&this.search()})}open(){this.overlay&&this.overlay.classList.add("visible"),this.modal&&this.modal.classList.add("visible")}close(){this.overlay&&this.overlay.classList.remove("visible"),this.modal&&this.modal.classList.remove("visible")}isOpen(){return this.modal?.classList.contains("visible")??!1}toggleInputs(){if(!this.modal)return;const t=this.modal.querySelector(".ratio-finder-inputs");t&&t.classList.toggle("collapsed")}getEventLocation(t){if("touches"in t&&t.touches&&t.touches.length===1)return{x:t.touches[0].clientX,y:t.touches[0].clientY};if("clientX"in t&&t.clientX&&t.clientY)return{x:t.clientX,y:t.clientY}}computeModalBounds(){if(!this.modal)return;const t=document.body.getBoundingClientRect(),e=this.modal.getBoundingClientRect();this.modalMinLeft=t.x,this.modalMaxLeft=t.x+t.width-e.width,this.modalMinTop=t.y,this.modalMaxTop=t.y+t.height-e.height}onHeaderDown(t){if(t.preventDefault(),this.dragStart=this.getEventLocation(t)??null,this.computeModalBounds(),this.dragStart&&this.modal){const e=this.modal.getBoundingClientRect();this.modal.style.transform="none",this.modal.style.left=e.left+"px",this.modal.style.top=e.top+"px",this.boundMouseMove=i=>this.onWindowMouseMove(i),this.boundMouseUp=()=>this.onWindowMouseUp(),document.addEventListener("mouseup",this.boundMouseUp),document.addEventListener("touchend",this.boundMouseUp),document.addEventListener("mousemove",this.boundMouseMove),document.addEventListener("touchmove",this.boundMouseMove,{passive:!1})}}onWindowMouseMove(t){t.preventDefault();const e=this.getEventLocation(t);if(e&&this.dragStart&&this.modal){let i=this.modal.offsetLeft+e.x-this.dragStart.x,a=this.modal.offsetTop+e.y-this.dragStart.y;i=Math.max(this.modalMinLeft,Math.min(this.modalMaxLeft,i)),a=Math.max(this.modalMinTop,Math.min(this.modalMaxTop,a)),this.modal.style.left=i+"px",this.modal.style.top=a+"px",this.dragStart=e}}onWindowMouseUp(){this.boundMouseUp&&(document.removeEventListener("mouseup",this.boundMouseUp),document.removeEventListener("touchend",this.boundMouseUp)),this.boundMouseMove&&(document.removeEventListener("mousemove",this.boundMouseMove),document.removeEventListener("touchmove",this.boundMouseMove))}getInputValues(){const t=this.inputs;return{csMin:parseFloat(t.csRangeMin.value),csMax:parseFloat(t.csRangeMax.value),ratioMin:parseFloat(t.ratioRangeMin.value),ratioMax:parseFloat(t.ratioRangeMax.value),cogMin:parseInt(t.cogRangeMin.value),cogMax:parseInt(t.cogRangeMax.value),chainringMin:parseInt(t.chainringRangeMin.value),chainringMax:parseInt(t.chainringRangeMax.value),chainLinksMin:parseInt(t.chainLinksRangeMin.value),chainLinksMax:parseInt(t.chainLinksRangeMax.value),allowHalfLink:t.allowHalfLink.checked,maxChainWear:parseFloat(t.maxChainWearInput.value)/100,chainringCount:parseInt(t.chainringCountInput.value)}}validateInputs(t){const e=[];return t.csMin>t.csMax&&e.push("Chainstay min must be ≤ max"),t.ratioMin>t.ratioMax&&e.push("Ratio min must be ≤ max"),t.cogMin>t.cogMax&&e.push("Cog min must be ≤ max"),t.chainringMin>t.chainringMax&&e.push("Chainring min must be ≤ max"),t.chainLinksMin>t.chainLinksMax&&e.push("Chain links min must be ≤ max"),e}search(){const t=this.getInputValues(),e=this.validateInputs(t);if(e.length>0&&this.resultsContainer){this.resultsContainer.innerHTML=`<p class="no-results">Invalid inputs:<br>${e.join("<br>")}</p>`;return}this.lastInputs=t,this.expandedRows.clear();const i=ot(t);this.renderResults(i)}renderResults(t){if(!this.resultsContainer)return;if(t.length===0){this.resultsContainer.innerHTML='<p class="no-results">No valid combinations found. Try expanding your ranges.</p>';return}let e=`
      <table class="ratio-finder-table">
        <thead>
          <tr>
            <th></th>
            <th>Chainring</th>
            <th>Links</th>
            <th>Ratios</th>
            <th>Score</th>
            <th title="Coverage: how much of target ratio range is achieved">Cov</th>
            <th title="Count: number of available ratios (log scale)">Cnt</th>
            <th title="Evenness: how evenly spaced the ratios are">Even</th>
            <th title="Reusability: cogs shared across chainrings">Reuse</th>
            <th>Max gap</th>
          </tr>
        </thead>
        <tbody>
    `;const i=100,a=t.slice(0,i);for(let s=0;s<a.length;s++){const n=a[s],r=`combo-${s}`,o=n.allCogs,c=n.allCogs.filter(l=>l.ratioValid);let d="0";if(c.length>0){const l=c.map(f=>f.ratio),u=Math.min(...l).toFixed(2),p=Math.max(...l).toFixed(2);d=`${n.ratioCount} (${u} → ${p})`}e+=`
        <tr class="result-row" data-row-id="${r}"
            data-chainrings="${n.chainrings}"
            data-chainlinks="${n.chainLinks}"
            data-index="${s}">
          <td><span class="expand-icon">▶</span></td>
          <td>${n.chainrings.join(",")}T</td>
          <td>${n.chainLinks}</td>
          <td>${d}</td>
          <td>${(n.score*100).toFixed(0)}%</td>
          <td>${(n.coverageScore*100).toFixed(0)}%</td>
          <td>${(n.countScore*100).toFixed(0)}%</td>
          <td>${(n.evennessScore*100).toFixed(0)}%</td>
          <td>${(n.reusabilityScore*100).toFixed(0)}%</td>
          <td>${n.maxGap.toFixed(2)}</td>
        </tr>
      `;for(const l of o){const u=l.ratioValid?"":" cog-invalid";e+=`
          <tr class="cog-details cog-detail-row${u}"
              data-parent="${r}"
              data-chainring="${l.chainring}"
              data-chainlinks="${n.chainLinks}"
              data-cog="${l.cog}"
              data-chainstay="${l.chainstay.toFixed(2)}"
              data-chainstayWeared="${l.chainstayWeared.toFixed(2)}">
            <td colspan="10">
              ${l.chainring}x${l.cog}:
              ratio ${l.ratio.toFixed(2)}
              —
              cs: ${l.chainstay.toFixed(1)}mm
              → ${l.chainstayWeared.toFixed(1)}mm (weared)
              —
              sp : ${l.skidPatchesSingleLegged} / ${l.skidPatchesAmbidextrous}
            </td>
          </tr>
        `}}e+="</tbody></table>",t.length>i&&(e+=`<p class="more-results">Showing top ${i} of ${t.length} combinations</p>`),this.resultsContainer.innerHTML=e,this.resultsContainer.querySelectorAll(".result-row").forEach(s=>{s.addEventListener("click",n=>this.toggleRow(s,n))}),this.resultsContainer.querySelectorAll(".cog-detail-row").forEach(s=>{s.addEventListener("click",n=>{n.stopPropagation(),this.applyFromCogRow(s)})})}toggleRow(t,e){const i=t.dataset.rowId;if(!i||!this.resultsContainer)return;t.classList.contains("expanded")?(t.classList.remove("expanded"),this.expandedRows.delete(i),this.resultsContainer.querySelectorAll(`.cog-details[data-parent="${i}"]`).forEach(s=>{s.classList.remove("visible")})):(t.classList.add("expanded"),this.expandedRows.add(i),this.resultsContainer.querySelectorAll(`.cog-details[data-parent="${i}"]`).forEach(s=>{s.classList.add("visible")}))}applyFromCogRow(t){const e=parseInt(t.dataset.chainring??"0"),i=parseInt(t.dataset.chainlinks??"0"),a=parseInt(t.dataset.cog??"0"),s=parseFloat(t.dataset.chainstay??"0");this.applyConfiguration(e,i,a,s)}applyConfiguration(t,e,i,a){this.state.f=t,this.state.r=i,this.state.cl=e,this.state.cs=a,this.main.resetComputer(),this.onUiUpdate()}}class ct{constructor(t,e,i){this.inputs=[],this.sidebar=null,this.sidebarHeader=null,this.sidebarContent=null,this.sidebarHeaderButton=null,this.sideBarVisible=!0,this.initialSidebarContentHeight=0,this.initialSidebarContentWidth=0,this.initialSidebarHeight=0,this.bodyHeight=0,this.sidebarMinLeft=0,this.sidebarMaxLeft=0,this.sidebarMinTop=0,this.sidebarMaxTop=0,this.state=t,this.main=e,this.interactive=i,this.initInputs(),this.ratioFinder=new ht(t,e,()=>this.update())}init(){const t=document.getElementById("resetState");if(t&&t.addEventListener("click",()=>this.resetState()),this.sidebar=document.getElementById("sidebar"),this.sidebarHeader=document.getElementById("sidebar-header"),this.sidebarContent=document.getElementById("sidebar-content"),this.sidebarHeader&&(this.sidebarHeader.addEventListener("mousedown",e=>this.onSidebarDown(e)),this.sidebarHeader.addEventListener("touchstart",e=>this.onSidebarDown(e))),this.sidebarHeaderButton=document.getElementById("sidebar-header-button"),this.sidebarHeaderButton&&(this.sidebarHeaderButton.addEventListener("click",()=>this.switchSidebar()),this.sidebarHeaderButton.addEventListener("touchend",()=>this.switchSidebar())),window.addEventListener("resize",()=>this.onResize()),this.ratioFinder.init(),this.sidebarContent&&this.sidebar){const e=this.sidebarContent.getBoundingClientRect();this.initialSidebarContentHeight=e.height,this.initialSidebarContentWidth=e.width;const i=this.sidebar.getBoundingClientRect();this.initialSidebarHeight=i.height,this.sidebarContent.style.height=this.initialSidebarContentHeight+"px";const a=document.body.getBoundingClientRect();a.height<this.initialSidebarContentHeight&&(this.sideBarVisible=!1),a.width<2*this.initialSidebarContentWidth&&(this.sideBarVisible=!1,this.sidebar.style.top=a.height+"px"),this.onSidebarVisibleChanged(),this.sideBarVisible&&this.interactive.onSidebar(i.width)}}initInputs(){this.inputs.push(new R("halfLinkChain",i=>x(parseFloat(i),1)+"%",()=>this.state.halfLinkChain,i=>{this.state.halfLinkChain=i,this.main.compute0()},i=>12.7*((100+i)/100),i=>100*i/12.7-100)),this.inputs.push(new R("simulationSpeed",i=>x(parseFloat(i),0)+"%",()=>this.state.simulationSpeed,i=>this.state.simulationSpeed=i,i=>i/100,i=>i*100)),this.inputs.push(new R("rotationSpeed",i=>x(parseFloat(i),1)+"rpm",()=>this.state.rotationSpeed,i=>this.state.rotationSpeed=i)),this.inputs.push(new R("f",i=>""+i,()=>this.state.f,i=>{this.state.f=i,this.main.resetComputer()})),this.inputs.push(new R("r",i=>""+i,()=>this.state.r,i=>{this.state.r=i,this.main.resetComputer()})),this.inputs.push(new R("cl",i=>""+i,()=>this.state.cl,i=>this.setCl(i)));let t,e;t=new R("cs1",()=>x(this.state.cs,2)+"mm",()=>Math.floor(this.state.cs),i=>{this.state.cs=i,e.reset(),this.main.compute0()}),e=new R("cs2",()=>x(this.state.cs,2)+"mm",()=>100*(this.state.cs-Math.floor(this.state.cs)),i=>{this.state.cs=Math.floor(this.state.cs)+i/100,t.reset(),this.main.compute0()}),this.inputs.push(t,e),this.inputs.push(new A("doDrawWheel",()=>this.state.doDrawWheel,i=>{this.state.doDrawWheel=i,this.main.drawIfPaused()})),this.inputs.push(new A("switchPause",()=>this.state.paused,i=>{this.state.paused=i,this.state.paused&&(this.state.fps=0),this.main.drawIfPaused()})),this.inputs.push(new A("switchDebug",()=>this.state.debug,i=>{this.state.debug=i,this.main.drawIfPaused()})),this.inputs.push(new A("followRivet",()=>this.state.followRivet,i=>{this.state.followRivet=i,this.main.drawIfPaused()}))}update(){this.inputs.forEach(t=>t.reset())}setCl(t){const e=this.state,i=t-e.cl,a=this.state.getRivetIndex(e.fru-e.frb),s=this.state.getRivetIndex(e.rrb-e.rru);e.cl=t,e.rotationSpeed>0?(e.frb=e.frb+i,e.fru=e.frb+a,e.rru=e.rrb-s):(e.rru=e.rru+i,e.rrb=e.rru+s,e.frb=e.fru-a),this.main.compute0()}resetState(){this.main.resetState()}getEventLocation(t){if("touches"in t&&t.touches&&t.touches.length===1)return{x:t.touches[0].clientX,y:t.touches[0].clientY};if("clientX"in t&&t.clientX&&t.clientY)return{x:t.clientX,y:t.clientY}}onResize(){if(this.computeSideBarBounds(),!this.sidebar)return;let t=this.sidebar.offsetLeft,e=this.sidebar.offsetTop;if(t=Math.max(this.sidebarMinLeft,Math.min(this.sidebarMaxLeft,t)),e=Math.max(this.sidebarMinTop,Math.min(this.sidebarMaxTop,e)),this.sidebar.style.left=t+"px",this.sidebar.style.top=e+"px",this.sideBarVisible&&this.sidebarContent)if(this.bodyHeight<this.initialSidebarHeight){const i=this.initialSidebarContentHeight-(this.initialSidebarHeight-this.bodyHeight);this.sidebarContent.style.height=i+"px"}else this.sidebarContent.style.height=this.initialSidebarContentHeight+"px"}computeSideBarBounds(){if(!this.sidebar)return;const t=document.body.getBoundingClientRect(),e=this.sidebar.getBoundingClientRect();this.bodyHeight=t.height,this.sidebarMinLeft=t.x,this.sidebarMaxLeft=t.x+t.width-e.width,this.sidebarMinTop=t.y,this.sidebarMaxTop=t.y+t.height-e.height}onSidebarDown(t){t.preventDefault(),this.dragStart=this.getEventLocation(t),this.computeSideBarBounds(),this.dragStart&&(document.onmouseup=()=>this.onWindowMouseUp(),document.ontouchend=()=>this.onWindowMouseUp(),document.onmousemove=e=>this.onWindowMouseMove(e),document.ontouchmove=e=>this.onWindowMouseMove(e))}onWindowMouseMove(t){t.preventDefault();const e=this.getEventLocation(t);if(e&&this.dragStart&&this.sidebar){let i=this.sidebar.offsetLeft+e.x-this.dragStart.x,a=this.sidebar.offsetTop+e.y-this.dragStart.y;i=Math.max(this.sidebarMinLeft,Math.min(this.sidebarMaxLeft,i)),a=Math.max(this.sidebarMinTop,Math.min(this.sidebarMaxTop,a)),this.sidebar.style.left=i+"px",this.sidebar.style.top=a+"px",this.dragStart=e}}onWindowMouseUp(){document.onmouseup=null,document.ontouchend=null,document.onmousemove=null,document.ontouchmove=null}switchSidebar(){this.sideBarVisible=!this.sideBarVisible,this.onSidebarVisibleChanged()}onSidebarVisibleChanged(){!this.sidebarContent||!this.sidebarHeaderButton||(this.sideBarVisible?(this.sidebarContent.style.height="100%",this.sidebarHeaderButton.innerText="▲",this.sidebarContent.style.height=this.initialSidebarContentHeight+"px"):(this.sidebarContent.style.height="0px",this.sidebarHeaderButton.innerText="▼",this.sidebarContent.style.height="0px"),this.onResize())}}function lt(){const h=new G;let t=null;const e=new K(h,"canvas",()=>t?.update());t=new ct(h,e,e.interactive),e.start(),t.init()}window.initBikeGearing=lt;
//# sourceMappingURL=index-BG255_Ou.js.map
